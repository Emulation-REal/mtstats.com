<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOOD VAULT - OAUTH UNLOCKED</title>
    <style>
        :root {
            --blood: #8B0000;
            --dark-blood: #3B0000;
            --glow: #FF3333;
            --text: #FF6666;
            --bg: #0F0000;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        canvas#stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        h1 { font-size: 3em; text-align: center; color: var(--glow); text-shadow: 0 0 20px var(--glow); margin: 20px 0; }

        /* LOGIN SCREEN */
        #login-screen {
            text-align: center; padding: 60px; background: rgba(0,0,0,0.7); border-radius: 20px; max-width: 600px; margin: 50px auto;
            border: 2px solid var(--glow); box-shadow: 0 0 30px var(--glow);
        }
        #login-btn {
            padding: 16px 40px; background: #0078D4; color: white; font-size: 1.3em; border: none; border-radius: 10px; cursor: pointer;
            box-shadow: 0 0 25px #0078D4; margin-top: 20px; font-weight: bold;
        }
        #login-btn:hover { background: #106EBE; transform: scale(1.05); }

        /* TOP BAR */
        #api-bar { display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0; padding: 10px; background: var(--dark-blood); border: 1px solid var(--glow); border-radius: 8px; overflow-x: auto; }
        .api-tab { padding: 10px 16px; background: var(--blood); color: var(--text); border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; transition: all 0.3s; }
        .api-tab:hover, .api-tab.active { background: var(--glow); color: #000; box-shadow: 0 0 15px var(--glow); }

        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; margin-top: 20px; }
        .sidebar { background: var(--dark-blood); border: 1px solid var(--glow); border-radius: 12px; padding: 20px; }
        .gamerpic { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--glow); box-shadow: 0 0 20px var(--glow); }
        .gamerscore { font-size: 2.2em; color: #FFD700; text-shadow: 0 0 15px #FFD700; }

        .tab-content { display: none; background: var(--dark-blood); border: 1px solid var(--glow); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .tab-content.active { display: block; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; background: var(--blood); color: var(--text); border: none; border-radius: 6px; cursor: pointer; }
        .tab-btn.active { background: var(--glow); color: #000; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 18px; }
        .card { background: var(--dark-blood); border: 1px solid var(--glow); border-radius: 10px; overflow: hidden; transition: transform 0.3s; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 0 25px var(--glow); }
        .card img { width: 100%; height: 170px; object-fit: cover; cursor: pointer; }

        #json-output { background: #000; color: #0f0; padding: 15px; border-radius: 8px; max-height: 600px; overflow: auto; font-family: monospace; white-space: pre-wrap; border: 1px solid var(--glow); }

        .loading { text-align: center; padding: 30px; color: var(--glow); font-size: 1.3em; }
        .error { background: rgba(255,0,0,0.2); color: #FF3333; padding: 15px; border-radius: 8px; border: 1px solid #FF3333; text-align: center; }

        #search-input { padding: 12px; width: 300px; background: var(--dark-blood); border: 1px solid var(--glow); color: var(--text); border-radius: 6px; }
        #fetch-btn { padding: 12px 24px; background: var(--glow); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .auth-badge {
            position: fixed; top: 10px; right: 10px; background: #000; color: #0f0; padding: 8px 12px; border: 1px solid #0f0; border-radius: 6px; font-size: 0.8em; z-index: 100;
            box-shadow: 0 0 15px #0f0; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }

        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<canvas id="stars"></canvas>

<!-- LOGIN SCREEN -->
<div id="login-screen">
    <h1>LOGIN TO XBOX LIVE</h1>
    <p style="margin:20px 0; color:#FF9999; font-size:1.1em;">Required for Clips, Friends, Achievements, Account</p>
    <button id="login-btn">LOGIN WITH MICROSOFT</button>
    <p style="margin-top:20px; font-size:0.9em; opacity:0.8;">Uses OpenXBL OAuth â€” Safe & Secure</p>
</div>

<!-- DASHBOARD (HIDDEN UNTIL LOGIN) -->
<div id="dashboard" class="container" style="display:none;">
    <div class="auth-badge">AUTHENTICATED</div>
    <h1>BLOOD VAULT - FULL ACCESS</h1>
    <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
        <input type="text" id="search-input" placeholder="Search Gamertag" value="major nelson">
        <button id="fetch-btn">SCAN TARGET</button>
    </div>

    <div id="api-bar"></div>

    <div class="dashboard">
        <div class="sidebar" id="player-summary">
            <div class="loading">LOADING PROFILE...</div>
        </div>

        <div>
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('clips')">CLIPS</button>
                <button class="tab-btn" onclick="switchTab('achievements')">ACHIEVEMENTS</button>
                <button class="tab-btn" onclick="switchTab('friends')">FRIENDS</button>
                <button class="tab-btn" onclick="switchTab('gamepass')">GAME PASS</button>
                <button class="tab-btn" onclick="switchTab('raw')">RAW JSON</button>
            </div>

            <div id="clips-tab" class="tab-content active">
                <div class="loading">FETCHING CLIPS...</div>
                <div id="clips-grid" class="grid"></div>
            </div>
            <div id="achievements-tab" class="tab-content">
                <div class="loading">UNLOCKING...</div>
                <div id="achievements-grid" class="grid"></div>
            </div>
            <div id="friends-tab" class="tab-content">
                <div class="loading">SCANNING...</div>
                <div id="friends-grid" class="grid"></div>
            </div>
            <div id="gamepass-tab" class="tab-content">
                <div class="loading">ACCESSING...</div>
                <div id="gamepass-grid" class="grid"></div>
            </div>
            <div id="raw-tab" class="tab-content">
                <div id="json-output">SELECT AN API</div>
            </div>
        </div>
    </div>
    <div id="error" class="error" style="display:none; margin-top:20px;"></div>
</div>

<script>
    const CORS_PROXY = 'https://corsproxy.io/?';
    const API_BASE = 'https://xbl.io/api/v2';
    const PUBLIC_KEY = '5444a61b-ae7a-477a-8877-99d4fd10af0b';
    let XBL_TOKEN = null;
    let CURRENT_XUID = '';
    let MY_XUID = '';

    // RED STARS
    const canvas = document.getElementById('stars');
    const ctx = canvas.getContext('2d');
    let stars = [];
    function initStars() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        stars = [];
        for (let i = 0; i < 120; i++) {
            stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 3 + 1, speed: Math.random() * 0.6 + 0.3, opacity: Math.random() });
        }
    }
    function drawStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        stars.forEach(s => {
            ctx.fillStyle = `rgba(255, 50, 50, ${s.opacity})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
            s.x -= s.speed; if (s.x < 0) s.x = canvas.width;
            s.opacity = Math.sin(Date.now() * 0.001 + s.x) * 0.5 + 0.5;
        });
        requestAnimationFrame(drawStars);
    }
    window.addEventListener('resize', initStars);
    initStars();
    drawStars();

    // OAUTH LOGIN
    document.getElementById('login-btn').onclick = () => {
        const redirectUri = encodeURIComponent(`${window.location.origin}${window.location.pathname}`);
        const authUrl = `https://xbl.io/auth?redirect=${redirectUri}`;
        window.location.href = authUrl;
    };

    // CHECK FOR TOKEN IN URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
        XBL_TOKEN = token;
        history.replaceState(null, null, window.location.pathname);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        initDashboard();
    }

    async function initDashboard() {
        buildApiBar();
        await loadMyProfile();
        document.getElementById('fetch-btn').click();
    }

    async function loadMyProfile() {
        const res = await fetchWithAuth(`${API_BASE}/account`);
        const data = await res.json();
        MY_XUID = data.profileUsers[0].id;
        const s = Object.fromEntries(data.profileUsers[0].settings.map(x => [x.id, x.value]));
        document.getElementById('player-summary').innerHTML = `
            <img src="${s.GameDisplayPicRaw}" class="gamerpic">
            <div style="margin-top:15px; font-size:1.6em;">${s.Gamertag}</div>
            <div class="gamerscore">${s.Gamerscore}G</div>
            <div style="margin-top:10px;">Tier: ${s.AccountTier}</div>
            ${s.Bio ? `<div style="margin-top:10px; color:#FF9999;">"${s.Bio}"</div>` : ''}
        `;
    }

    const ENDPOINTS = [
        { name: "My Account", path: "/account", auth: true },
        { name: "My Clips", path: "/dvr/gameclips", auth: true },
        { name: "My Friends", path: "/friends", auth: true },
        { name: "My Achievements", path: "/achievements", auth: true },
        { name: "Profile", path: "/account/{xuid}", auth: false },
        { name: "Player Achs", path: "/achievements/player/{xuid}", auth: false },
        { name: "Game Pass", path: "/gamepass/all", auth: false },
        { name: "Deals", path: "/marketplace/deals", auth: false }
    ];

    function buildApiBar() {
        const bar = document.getElementById('api-bar');
        ENDPOINTS.forEach((ep, i) => {
            const btn = document.createElement('button');
            btn.className = 'api-tab';
            btn.textContent = ep.name;
            btn.onclick = () => {
                document.querySelectorAll('.api-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                callApi(ep);
            };
            bar.appendChild(btn);
            if (i === 0) setTimeout(() => btn.click(), 500);
        });
    }

    async function callApi(ep) {
        let path = ep.path.replace('{xuid}', CURRENT_XUID || MY_XUID);
        const url = ep.auth ? `${API_BASE}${path}` : `${CORS_PROXY}${API_BASE}${path}?key=${PUBLIC_KEY}`;
        const headers = ep.auth ? { 'Authorization': `Bearer ${XBL_TOKEN}` } : {};
        showLoadingIn('#json-output', 'EXECUTING...');
        try {
            const res = await fetch(url, { headers });
            const data = await res.json();
            document.getElementById('json-output').textContent = JSON.stringify(data, null, 2);
        } catch (err) {
            document.getElementById('json-output').textContent = `ERROR: ${err.message}`;
        }
    }

    document.getElementById('fetch-btn').onclick = async () => {
        const input = document.getElementById('search-input').value.trim();
        if (!input) return;
        try {
            let xuid = input;
            if (!/^\d+$/.test(input)) {
                const res = await fetch(`${CORS_PROXY}${API_BASE}/xuid/${encodeURIComponent(input)}?key=${PUBLIC_KEY}`);
                const data = await res.json();
                xuid = data.xuid;
            }
            CURRENT_XUID = xuid;
            await Promise.all([loadPublicProfile(xuid), loadPublicAchievements(xuid)]);
        } catch (err) {
            showError(`SCAN FAILED: ${err.message}`);
        }
    };

    async function loadPublicProfile(xuid) {
        const res = await fetch(`${CORS_PROXY}${API_BASE}/account/${xuid}?key=${PUBLIC_KEY}`);
        const data = await res.json();
        const s = Object.fromEntries(data.profileUsers[0].settings.map(x => [x.id, x.value]));
        document.getElementById('player-summary').innerHTML = `
            <img src="${s.GameDisplayPicRaw}" class="gamerpic">
            <div style="margin-top:15px; font-size:1.6em;">${s.Gamertag}</div>
            <div class="gamerscore">${s.Gamerscore}G</div>
        `;
    }

    async function loadPublicAchievements(xuid) {
        const res = await fetch(`${CORS_PROXY}${API_BASE}/achievements/player/${xuid}?key=${PUBLIC_KEY}`);
        const data = await res.json();
        const grid = document.getElementById('achievements-grid');
        grid.innerHTML = '';
        data.achievements.slice(0, 12).forEach(a => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<img src="${a.mediaAssets[0]?.url}" style="height:100px;"><div class="card-info"><div>${a.name}</div></div>`;
            grid.appendChild(div);
        });
    }

    // AUTH FETCH HELPER
    async function fetchWithAuth(url) {
        return fetch(url, { headers: { 'Authorization': `Bearer ${XBL_TOKEN}` } });
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById(id + '-tab').classList.add('active');
    }

    function showLoadingIn(sel, msg) { document.querySelector(sel).textContent = msg; }
    function showError(msg) { const el = document.getElementById('error'); el.textContent = msg; el.style.display = 'block'; }
</script>
</body>
</html>
